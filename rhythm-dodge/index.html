<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rhythm Dodge</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0a1a;overflow:hidden;font-family:'Segoe UI',Tahoma,sans-serif}
canvas{display:block}
#fileInput{display:none}
</style>
</head>
<body>
<canvas id="game"></canvas>
<input type="file" id="fileInput" accept="audio/*" multiple>
<script>
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');
const fileInput=document.getElementById('fileInput');
let W,H;
function resize(){W=canvas.width=innerWidth;H=canvas.height=innerHeight;}
resize();window.addEventListener('resize',resize);

// ─── CONSTANTS ───
const LANE_KEYS=['KeyD','KeyF','KeyJ','KeyK'];
const LANE_LABELS=['D','F','J','K'];
const LANE_COLORS=['#ff3355','#3355ff','#ff33ff','#33ffdd'];
const LANE_COUNT=4;
const HIT_Y_FRAC=0.85;
const NOTE_W_FRAC=0.08;
const NOTE_H=40;
let SCROLL_TIME=2.0;

const PERFECT_W=0.04,GREAT_W=0.08,GOOD_W=0.12,MISS_W=0.15;

// ─── STATE ───
let state='menu'; // menu, songSelect, playing, results
let audioCtx=null;
let difficulty='normal';
let song=null;
let songTime=0,songStartRealTime=0;
let songSource=null; // AudioBufferSourceNode for loaded music
let score=0,combo=0,maxCombo=0;
let perfects=0,greats=0,goods=0,misses=0;
let totalNotes=0;
let particles=[];
let bgParticles=[];
let laneFlash=[0,0,0,0];
let laneMissFlash=[0,0,0,0];
let screenShake=0;
let keys={};

// ─── MUSIC LIBRARY ───
let musicLibrary=[]; // [{name, buffer (AudioBuffer), bpm, duration}]
let selectedSongIdx=0;
let songSelectScroll=0;

for(let i=0;i<60;i++){
  bgParticles.push({x:Math.random()*2000,y:Math.random()*1200,vy:-10-Math.random()*30,
    size:1+Math.random()*2,alpha:0.1+Math.random()*0.2});
}

// ─── LANE GEOMETRY ───
function laneX(i){
  const totalW=LANE_COUNT*NOTE_W_FRAC*W+(LANE_COUNT-1)*8;
  return W/2-totalW/2+i*(NOTE_W_FRAC*W+8);
}
function noteW(){return NOTE_W_FRAC*W;}
function hitY(){return H*HIT_Y_FRAC;}

// ─── AUDIO ANALYSIS ───
function analyzeAudio(buffer){
  // Analyze in frequency bands to detect different instruments
  // Low (kick/bass) → lanes 0,1 | Mid (snare/vocals) → lanes 1,2 | High (hats/cymbals) → lanes 2,3
  const sr=buffer.sampleRate;
  const data=buffer.getChannelData(0);
  const fftSize=2048;
  const hopSize=Math.floor(sr*0.01); // 10ms hops for precision

  // Compute spectral flux in 3 bands
  function bandEnergy(frame,loFrac,hiFrac){
    // Simple band energy using time-domain filtering approximation
    // We'll use windowed energy at different frequency emphasis
    let e=0;
    for(let j=0;j<fftSize&&frame+j<data.length;j++){
      e+=data[frame+j]*data[frame+j];
    }
    return e/fftSize;
  }

  // Compute onset strength per band using spectral flux approach
  function getOnsets(data,sr,filterFn){
    const winSize=1024;
    const hop=Math.floor(sr*0.01);
    const energies=[];
    for(let i=0;i<data.length-winSize;i+=hop){
      let e=0;
      for(let j=0;j<winSize;j++){
        const s=filterFn(data[i+j],j,winSize,sr);
        e+=s*s;
      }
      energies.push(e/winSize);
    }
    // Onset detection: find frames where energy rises sharply
    const onsets=[];
    const localW=15;
    for(let i=localW;i<energies.length-localW;i++){
      let localAvg=0,localMax=0;
      for(let j=i-localW;j<i+localW;j++){localAvg+=energies[j];localMax=Math.max(localMax,energies[j]);}
      localAvg/=(localW*2);
      const rise=energies[i]-energies[i-1];
      if(rise>0&&energies[i]>localAvg*1.4&&energies[i]>localMax*0.5){
        const t=i*hop/sr;
        // Minimum gap between onsets
        if(onsets.length===0||t-onsets[onsets.length-1]>0.08){
          onsets.push(t);
        }
      }
    }
    return onsets;
  }

  // Low-pass emphasis (kick/bass): keep low frequencies
  const lowOnsets=getOnsets(data,sr,(s,j,w,sr2)=>{
    // Simple moving average acts as low-pass
    return s*Math.max(0,1-j/64);
  });

  // Band-pass emphasis (snare/mids)
  const midOnsets=getOnsets(data,sr,(s,j,w,sr2)=>{
    return s*Math.sin(Math.PI*j/w);
  });

  // High-pass emphasis (hats/highs): emphasize rapid changes
  const highOnsets=getOnsets(data,sr,(s,j,w,sr2)=>{
    return s*Math.min(1,j/32);
  });

  // Estimate BPM from low onsets (most reliable for beat)
  let bpm=120;
  if(lowOnsets.length>4){
    const intervals=[];
    for(let i=1;i<Math.min(lowOnsets.length,300);i++){
      const d=lowOnsets[i]-lowOnsets[i-1];
      if(d>0.2&&d<1.5)intervals.push(d);
    }
    if(intervals.length>2){
      intervals.sort((a,b)=>a-b);
      // Find most common interval
      let bestCount=0,bestVal=intervals[Math.floor(intervals.length/2)];
      for(let i=0;i<intervals.length;i++){
        let count=0;
        for(let j=0;j<intervals.length;j++){
          if(Math.abs(intervals[i]-intervals[j])<0.03)count++;
        }
        if(count>bestCount){bestCount=count;bestVal=intervals[i];}
      }
      bpm=Math.round(60/bestVal);
      while(bpm<80)bpm*=2;
      while(bpm>180)bpm/=2;
    }
  }

  return{lowOnsets,midOnsets,highOnsets,bpm,duration:buffer.duration};
}

// ─── GENERATE NOTES FROM ONSETS ───
function generateNotesFromAnalysis(analysis,diff){
  const{lowOnsets,midOnsets,highOnsets,duration}=analysis;
  const leadIn=1.5;
  const notes=[];
  const minGap=diff==='easy'?0.35:diff==='normal'?0.2:0.12;

  // Map band onsets to lanes
  // Low → lane 0 or 1 (alternating)
  let lowLane=0;
  for(const t of lowOnsets){
    if(t>duration-1)break;
    notes.push({time:leadIn+t,lane:lowLane,band:'low',hit:false,missed:false});
    lowLane=lowLane===0?1:0;
  }
  // Mid → lane 1 or 2
  let midLane=2;
  for(const t of midOnsets){
    if(t>duration-1)break;
    notes.push({time:leadIn+t,lane:midLane,band:'mid',hit:false,missed:false});
    midLane=midLane===1?2:1;
  }
  // High → lane 2 or 3
  let highLane=3;
  for(const t of highOnsets){
    if(t>duration-1)break;
    notes.push({time:leadIn+t,lane:highLane,band:'high',hit:false,missed:false});
    highLane=highLane===2?3:2;
  }

  notes.sort((a,b)=>a.time-b.time);

  // Remove notes too close together in same lane
  const cleaned=[];
  const lastInLane=[0,0,0,0];
  for(const n of notes){
    if(n.time-lastInLane[n.lane]<minGap)continue;
    lastInLane[n.lane]=n.time;
    cleaned.push(n);
  }

  // Limit simultaneous notes
  const maxSim=diff==='easy'?1:diff==='normal'?2:3;
  const limited=[];
  for(const n of cleaned){
    if(limited.filter(f=>Math.abs(f.time-n.time)<0.04).length<maxSim)
      limited.push(n);
  }

  // Difficulty thinning: on easy, keep fewer notes
  let final=limited;
  if(diff==='easy'){
    final=limited.filter((_,i)=>i%3===0||_.band==='low');
  }else if(diff==='normal'){
    final=limited.filter((_,i)=>i%2===0||_.band==='low'||_.band==='mid');
  }

  // Ensure minimum gap after thinning
  const result=[];
  let lastT=-1;
  for(const n of final){
    if(n.time-lastT<(diff==='easy'?0.3:0.1))continue;
    result.push(n);
    lastT=n.time;
  }

  return result;
}

// ─── PROCEDURAL SONG (fallback) ───
function generateProceduralSong(diff){
  const bpm=diff==='easy'?110:diff==='normal'?125:140;
  const beatLen=60/bpm;
  const bars=diff==='easy'?20:diff==='normal'?24:28;
  const totalBeats=bars*4;
  const duration=totalBeats*beatLen+2;
  const notes=[];
  const leadIn=2;
  const pentatonic=[261.6,293.7,329.6,392.0,440.0,523.3,587.3,659.3];
  const kickLane=Math.floor(Math.random()*2);
  const snareLane=2+Math.floor(Math.random()*2);

  for(let bar=0;bar<bars;bar++){
    for(let beat=0;beat<4;beat++){
      const time=leadIn+(bar*4+beat)*beatLen;
      if(beat===0||beat===2){
        const ch=diff==='easy'?0.4:diff==='normal'?0.7:1;
        if(Math.random()<ch)
          notes.push({time,lane:kickLane,sound:'kick',hit:false,missed:false});
      }
      if(beat===1||beat===3){
        const ch=diff==='easy'?0.35:diff==='normal'?0.65:1;
        if(Math.random()<ch)
          notes.push({time,lane:snareLane,sound:'snare',hit:false,missed:false});
      }
      const melCh=diff==='easy'?0.08:diff==='normal'?0.18:0.35;
      if(Math.random()<melCh){
        const lane=Math.floor(Math.random()*LANE_COUNT);
        const freq=pentatonic[Math.floor(Math.random()*pentatonic.length)];
        if(!notes.find(n=>Math.abs(n.time-time)<0.02&&n.lane===lane)){
          notes.push({time,lane,sound:'melody',freq,hit:false,missed:false});
        }
      }
    }
  }

  const maxSim=diff==='easy'?2:diff==='normal'?3:4;
  notes.sort((a,b)=>a.time-b.time);
  const filtered=[];
  for(const n of notes){
    if(filtered.filter(f=>Math.abs(f.time-n.time)<0.02).length<maxSim)
      filtered.push(n);
  }
  return{bpm,notes:filtered,duration,beatLen,isLoaded:false};
}

// ─── FILE LOADING ───
fileInput.addEventListener('change',async e=>{
  initAudio();
  for(const file of e.target.files){
    try{
      const arrayBuf=await file.arrayBuffer();
      const audioBuf=await audioCtx.decodeAudioData(arrayBuf);
      const analysis=analyzeAudio(audioBuf);
      const name=file.name.replace(/\.[^.]+$/,'');
      musicLibrary.push({name,buffer:audioBuf,bpm:analysis.bpm,duration:audioBuf.duration,analysis});
    }catch(err){console.error('Failed to load:',file.name,err);}
  }
  fileInput.value='';
  if(state==='songSelect'){}// just refresh
});

function loadSongs(){
  initAudio();
  fileInput.click();
}

// ─── INPUT ───
document.addEventListener('keydown',e=>{
  if(e.repeat)return;
  keys[e.code]=true;
  const li=LANE_KEYS.indexOf(e.code);
  if(li>=0){
    e.preventDefault();
    if(state==='playing')handleHit(li);
  }
  if(e.code==='Space'){
    e.preventDefault();
    if(state==='menu')state='songSelect';
    else if(state==='results')state='songSelect';
  }
  if(e.code==='Escape'){
    if(state==='playing'){stopSong();state='songSelect';}
    else if(state==='results'||state==='songSelect')state='menu';
  }
  if(state==='menu'){
    if(e.code==='Digit1')difficulty='easy';
    if(e.code==='Digit2')difficulty='normal';
    if(e.code==='Digit3')difficulty='hard';
  }
});
document.addEventListener('keyup',e=>{keys[e.code]=false;});

function handleHit(lane){
  if(!song)return;
  let best=null,bestDiff=Infinity;
  for(const n of song.notes){
    if(n.lane!==lane||n.hit||n.missed)continue;
    const diff=Math.abs(n.time-songTime);
    if(diff<bestDiff&&diff<MISS_W){bestDiff=diff;best=n;}
  }
  if(!best){
    // Wrong button — no note in this lane, counts as miss
    misses++;combo=0;
    laneMissFlash[lane]=0.3;
    sfxMiss();
    return;
  }

  best.hit=true;
  let rating='';
  if(bestDiff<=PERFECT_W){rating='perfect';perfects++;score+=100*comboMult();combo++;screenShake=6;}
  else if(bestDiff<=GREAT_W){rating='great';greats++;score+=70*comboMult();combo++;}
  else{rating='good';goods++;score+=40*comboMult();combo++;}

  if(combo>maxCombo)maxCombo=combo;
  laneFlash[lane]=0.3;
  sfxHit();

  const cx=laneX(lane)+noteW()/2,cy=hitY();
  const color=LANE_COLORS[lane];
  const count=rating==='perfect'?25:rating==='great'?15:8;
  for(let i=0;i<count;i++){
    const ang=Math.random()*Math.PI*2,spd=100+Math.random()*300;
    particles.push({x:cx,y:cy,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,
      life:0.3+Math.random()*0.4,maxLife:0.7,color,r:2+Math.random()*4});
  }
  particles.push({x:cx,y:cy-30,vx:0,vy:-60,life:0.6,maxLife:0.6,color:'#fff',r:0,text:rating.toUpperCase()});
}

function comboMult(){
  if(combo>=50)return 8;if(combo>=30)return 4;if(combo>=10)return 2;return 1;
}

function startSong(songIdx){
  initAudio();
  SCROLL_TIME=difficulty==='easy'?2.8:difficulty==='normal'?2.2:1.6;

  if(songIdx!=null&&songIdx>=0&&songIdx<musicLibrary.length){
    // Loaded song
    const lib=musicLibrary[songIdx];
    const notes=generateNotesFromAnalysis(lib.analysis,difficulty);
    song={bpm:lib.bpm,notes,duration:lib.duration+1.5,beatLen:60/lib.bpm,isLoaded:true,songIdx};
    songTime=-1.5;
    songStartRealTime=performance.now()/1000+1.5;
    // Play audio
    songSource=audioCtx.createBufferSource();
    songSource.buffer=lib.buffer;
    songSource.connect(audioCtx.destination);
    songSource.start(audioCtx.currentTime+1.5);
  }else{
    // Procedural
    song=generateProceduralSong(difficulty);
    songTime=-0.5;
    songStartRealTime=performance.now()/1000+0.5;
    scheduleProceduralMusic();
  }

  score=0;combo=0;maxCombo=0;
  perfects=0;greats=0;goods=0;misses=0;
  totalNotes=song.notes.length;
  particles=[];laneFlash=[0,0,0,0];laneMissFlash=[0,0,0,0];
  screenShake=0;
  state='playing';
}

function stopSong(){
  if(songSource){try{songSource.stop();}catch(e){}songSource=null;}
}

// ─── AUDIO ───
function initAudio(){
  if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state==='suspended')audioCtx.resume();
}

function scheduleProceduralMusic(){
  if(!audioCtx||!song)return;
  const baseTime=audioCtx.currentTime+0.5;
  for(const n of song.notes){
    scheduleSoundAt(n,baseTime+n.time);
  }
}

function scheduleSoundAt(note,when){
  if(!audioCtx)return;
  try{
    const t=when;
    if(note.sound==='kick'){
      const o=audioCtx.createOscillator(),g=audioCtx.createGain();
      o.connect(g);g.connect(audioCtx.destination);
      o.type='sine';o.frequency.setValueAtTime(150,t);o.frequency.exponentialRampToValueAtTime(40,t+0.12);
      g.gain.setValueAtTime(0.25,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.15);
      o.start(t);o.stop(t+0.15);
    }else if(note.sound==='snare'){
      const bufLen=audioCtx.sampleRate*0.1;
      const buf=audioCtx.createBuffer(1,bufLen,audioCtx.sampleRate);
      const data=buf.getChannelData(0);
      for(let i=0;i<bufLen;i++)data[i]=(Math.random()*2-1)*0.3;
      const src=audioCtx.createBufferSource();src.buffer=buf;
      const g=audioCtx.createGain();src.connect(g);g.connect(audioCtx.destination);
      g.gain.setValueAtTime(0.15,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.1);
      src.start(t);src.stop(t+0.1);
    }else if(note.sound==='melody'){
      const freq=note.freq||440;
      const o=audioCtx.createOscillator(),g=audioCtx.createGain();
      o.connect(g);g.connect(audioCtx.destination);
      o.type='triangle';o.frequency.setValueAtTime(freq,t);
      g.gain.setValueAtTime(0.07,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.25);
      o.start(t);o.stop(t+0.25);
    }
  }catch(e){}
}

function sfxHit(){
  if(!audioCtx)return;
  try{
    const t=audioCtx.currentTime;
    const o=audioCtx.createOscillator(),g=audioCtx.createGain();
    o.connect(g);g.connect(audioCtx.destination);
    o.type='sine';o.frequency.setValueAtTime(1400,t);o.frequency.exponentialRampToValueAtTime(800,t+0.04);
    g.gain.setValueAtTime(0.05,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.05);
    o.start(t);o.stop(t+0.05);
  }catch(e){}
}

function sfxMiss(){
  if(!audioCtx)return;
  try{
    const t=audioCtx.currentTime;
    const o=audioCtx.createOscillator(),g=audioCtx.createGain();
    o.connect(g);g.connect(audioCtx.destination);
    o.type='sine';o.frequency.setValueAtTime(100,t);o.frequency.exponentialRampToValueAtTime(60,t+0.1);
    g.gain.setValueAtTime(0.06,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.12);
    o.start(t);o.stop(t+0.12);
  }catch(e){}
}

// ─── UPDATE ───
function update(dt){
  for(const p of bgParticles){
    p.y+=p.vy*dt;
    if(p.y<-10){p.y=H+10;p.x=Math.random()*W;}
  }

  if(state!=='playing'){updateParticles(dt);return;}

  songTime=performance.now()/1000-songStartRealTime;
  updateParticles(dt);

  for(let i=0;i<4;i++){
    if(laneFlash[i]>0)laneFlash[i]-=dt;
    if(laneMissFlash[i]>0)laneMissFlash[i]-=dt;
  }
  if(screenShake>0)screenShake=Math.max(0,screenShake-dt*30);

  for(const n of song.notes){
    if(!n.hit&&!n.missed&&n.time<songTime-MISS_W){
      n.missed=true;misses++;combo=0;
      laneMissFlash[n.lane]=0.3;
      sfxMiss();
    }
  }

  if(songTime>song.duration){
    stopSong();
    state='results';
  }
}

function updateParticles(dt){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx*dt;p.y+=p.vy*dt;
    p.vx*=0.96;p.vy*=0.96;
    p.life-=dt;
    if(p.life<=0)particles.splice(i,1);
  }
}

// ─── DRAW ───
function draw(){
  ctx.fillStyle='#0a0a1a';ctx.fillRect(0,0,W,H);

  for(const p of bgParticles){
    ctx.globalAlpha=p.alpha;ctx.fillStyle='#335';
    ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,Math.PI*2);ctx.fill();
  }
  ctx.globalAlpha=1;

  if(state==='menu'){drawMenu();return;}
  if(state==='songSelect'){drawSongSelect();return;}
  if(state==='results'){drawResults();return;}

  // Screen shake
  const sx=screenShake>0?(Math.random()-0.5)*screenShake:0;
  const sy=screenShake>0?(Math.random()-0.5)*screenShake:0;
  ctx.save();ctx.translate(sx,sy);

  const hy=hitY(),nw=noteW();

  // Lane backgrounds
  for(let i=0;i<LANE_COUNT;i++){
    const lx=laneX(i);
    ctx.fillStyle='rgba(255,255,255,0.02)';ctx.fillRect(lx,0,nw,H);
    if(laneFlash[i]>0){
      ctx.fillStyle=`rgba(${hexToRgb(LANE_COLORS[i])},${laneFlash[i]*0.4})`;
      ctx.fillRect(lx,0,nw,H);
    }
    if(laneMissFlash[i]>0){
      ctx.fillStyle=`rgba(255,0,0,${laneMissFlash[i]*0.3})`;
      ctx.fillRect(lx,0,nw,H);
    }
  }

  // Hit zone
  const pulse=0.6+0.4*Math.sin(performance.now()/200);
  ctx.strokeStyle=`rgba(255,255,255,${0.3+pulse*0.3})`;ctx.lineWidth=2;
  ctx.beginPath();ctx.moveTo(laneX(0)-10,hy);ctx.lineTo(laneX(3)+nw+10,hy);ctx.stroke();
  const grad=ctx.createLinearGradient(0,hy-20,0,hy+20);
  grad.addColorStop(0,'rgba(255,255,255,0)');
  grad.addColorStop(0.5,`rgba(255,255,255,${0.05+pulse*0.05})`);
  grad.addColorStop(1,'rgba(255,255,255,0)');
  ctx.fillStyle=grad;
  ctx.fillRect(laneX(0)-10,hy-20,laneX(3)+nw+10-laneX(0)+20,40);

  // Key indicators
  for(let i=0;i<LANE_COUNT;i++){
    const lx=laneX(i),cx=lx+nw/2;
    const pressed=keys[LANE_KEYS[i]];
    ctx.fillStyle=pressed?LANE_COLORS[i]:'rgba(255,255,255,0.15)';
    roundRect(ctx,lx+4,hy-18,nw-8,36,8);ctx.fill();
    ctx.fillStyle=pressed?'#fff':'rgba(255,255,255,0.4)';
    ctx.font='bold 16px "Segoe UI",sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(LANE_LABELS[i],cx,hy);
  }

  // Notes
  if(song){
    for(const n of song.notes){
      if(n.hit||n.missed)continue;
      const timeDiff=n.time-songTime;
      if(timeDiff>SCROLL_TIME+0.5||timeDiff<-0.5)continue;
      const noteY=hy-timeDiff/SCROLL_TIME*(hy-50);
      const lx=laneX(n.lane);
      const color=LANE_COLORS[n.lane];
      ctx.fillStyle=color+'22';
      ctx.beginPath();ctx.arc(lx+nw/2,noteY,nw*0.6,0,Math.PI*2);ctx.fill();
      ctx.fillStyle=color;
      roundRect(ctx,lx+3,noteY-NOTE_H/2,nw-6,NOTE_H,8);ctx.fill();
      ctx.fillStyle='#fff';ctx.font='bold 18px "Segoe UI",sans-serif';
      ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText(LANE_LABELS[n.lane],lx+nw/2,noteY);
    }
  }

  // Particles
  for(const p of particles){
    const a=Math.max(0,p.life/p.maxLife);
    ctx.globalAlpha=a;
    if(p.text){
      ctx.fillStyle=p.color;ctx.font='bold 20px "Segoe UI",sans-serif';
      ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(p.text,p.x,p.y);
    }else{
      ctx.fillStyle=p.color;
      ctx.beginPath();ctx.arc(p.x,p.y,p.r*a,0,Math.PI*2);ctx.fill();
    }
  }
  ctx.globalAlpha=1;
  ctx.restore();

  // HUD
  ctx.textAlign='center';ctx.textBaseline='top';
  ctx.font='bold 36px "Segoe UI",sans-serif';ctx.fillStyle='#fff';
  ctx.fillText(score.toLocaleString(),W/2,15);
  if(combo>1){
    const cm=comboMult();
    ctx.font='bold 22px "Segoe UI",sans-serif';
    ctx.fillStyle=cm>=8?'#ff3355':cm>=4?'#ff33ff':cm>=2?'#33ffdd':'#888';
    ctx.fillText(`${combo} combo (x${cm})`,W/2,55);
  }
  const totalHit=perfects+greats+goods+misses;
  const acc=totalHit>0?((perfects+greats*0.7+goods*0.4)/totalHit*100):100;
  ctx.textAlign='right';ctx.font='16px "Segoe UI",sans-serif';ctx.fillStyle='#888';
  ctx.fillText(`${acc.toFixed(1)}%`,W-20,20);
  if(song){
    const prog=Math.max(0,Math.min(1,songTime/song.duration));
    ctx.fillStyle='rgba(255,255,255,0.1)';ctx.fillRect(0,0,W,3);
    ctx.fillStyle='#0df';ctx.fillRect(0,0,W*prog,3);
  }
}

function drawMenu(){
  ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.font='bold 56px "Segoe UI",sans-serif';
  ctx.shadowColor='#ff33ff';ctx.shadowBlur=30;
  ctx.fillStyle='#fff';ctx.fillText('RHYTHM DODGE',W/2,H*0.25);
  ctx.shadowBlur=0;
  ctx.font='18px "Segoe UI",sans-serif';ctx.fillStyle='#667';
  ctx.fillText('Hit the beat. Chase the combo.',W/2,H*0.25+42);

  // Difficulty
  const diffs=['easy','normal','hard'];
  const diffLabels=['Easy','Normal','Hard'];
  const diffColors=['#33ffdd','#3355ff','#ff3355'];
  const bw=130,bh=45,gap=20;
  const totalBW=diffs.length*bw+(diffs.length-1)*gap;
  const startBX=W/2-totalBW/2;

  ctx.font='14px "Segoe UI",sans-serif';ctx.fillStyle='#556';
  ctx.fillText('Select difficulty (1/2/3)',W/2,H*0.42);

  for(let i=0;i<diffs.length;i++){
    const bx=startBX+i*(bw+gap),by=H*0.47;
    const active=difficulty===diffs[i];
    ctx.fillStyle=active?diffColors[i]+'22':'rgba(255,255,255,0.03)';
    roundRect(ctx,bx,by,bw,bh,8);ctx.fill();
    ctx.strokeStyle=active?diffColors[i]:'#333';ctx.lineWidth=active?2:1;
    roundRect(ctx,bx,by,bw,bh,8);ctx.stroke();
    ctx.fillStyle=active?diffColors[i]:'#888';
    ctx.font=`${active?'bold ':''}16px "Segoe UI",sans-serif`;
    ctx.fillText(diffLabels[i],bx+bw/2,by+bh/2);
  }

  // Select Music button
  const pw=200,ph=55,px=W/2-pw/2,py=H*0.58;
  ctx.fillStyle='rgba(0,220,255,0.1)';roundRect(ctx,px,py,pw,ph,10);ctx.fill();
  ctx.strokeStyle='#0df';ctx.lineWidth=2;roundRect(ctx,px,py,pw,ph,10);ctx.stroke();
  ctx.fillStyle='#0df';ctx.font='bold 22px sans-serif';
  ctx.fillText('Select Music',W/2,py+ph/2);
  canvas._menuPlayBtn={x:px,y:py,w:pw,h:ph};
  canvas._diffBtns=diffs.map((d,i)=>({x:startBX+i*(bw+gap),y:H*0.47,w:bw,h:bh,diff:d}));

  // Song count
  ctx.font='13px "Segoe UI",sans-serif';ctx.fillStyle='#556';
  const songCount=musicLibrary.length;
  ctx.fillText(songCount>0?`${songCount} song${songCount>1?'s':''} loaded`:'No songs loaded yet',W/2,py+ph+18);

  // Controls
  ctx.font='14px "Segoe UI",sans-serif';ctx.fillStyle='#556';
  ctx.fillText('Controls:  D  F  J  K',W/2,H*0.78);
  ctx.fillText('Esc: back',W/2,H*0.78+24);

  for(let i=0;i<4;i++){
    const x=W/2-80+i*50,y=H*0.86;
    ctx.fillStyle=LANE_COLORS[i];ctx.font='bold 20px "Segoe UI",sans-serif';
    ctx.fillText(LANE_LABELS[i],x,y);
  }
}

function drawSongSelect(){
  ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.font='bold 36px "Segoe UI",sans-serif';ctx.fillStyle='#0df';
  ctx.fillText('SELECT SONG',W/2,50);

  // Add songs button
  const abw=180,abh=40,abx=W/2-abw/2,aby=85;
  ctx.fillStyle='rgba(255,170,0,0.1)';roundRect(ctx,abx,aby,abw,abh,8);ctx.fill();
  ctx.strokeStyle='#fa0';ctx.lineWidth=1;roundRect(ctx,abx,aby,abw,abh,8);ctx.stroke();
  ctx.fillStyle='#fa0';ctx.font='bold 14px sans-serif';
  ctx.fillText('+ Add Songs',W/2,aby+abh/2);
  canvas._addSongsBtn={x:abx,y:aby,w:abw,h:abh};

  // Procedural option
  const listTop=140,itemH=60,listW=500;
  const ox=W/2-listW/2;

  // "Random Generated" option
  const py=listTop;
  const selProcedural=selectedSongIdx===-1;
  ctx.fillStyle=selProcedural?'rgba(0,220,255,0.12)':'rgba(255,255,255,0.03)';
  roundRect(ctx,ox,py,listW,itemH-5,8);ctx.fill();
  ctx.strokeStyle=selProcedural?'#0df':'#333';ctx.lineWidth=selProcedural?2:1;
  roundRect(ctx,ox,py,listW,itemH-5,8);ctx.stroke();
  ctx.textAlign='left';ctx.fillStyle=selProcedural?'#0df':'#ccc';
  ctx.font='bold 16px "Segoe UI",sans-serif';
  ctx.fillText('Random Generated',ox+16,py+20);
  ctx.font='12px "Segoe UI",sans-serif';ctx.fillStyle='#888';
  ctx.fillText('Procedural beats — no audio file needed',ox+16,py+38);
  canvas._proceduralBtn={x:ox,y:py,w:listW,h:itemH-5};

  // Loaded songs
  canvas._songBtns=[];
  for(let i=0;i<musicLibrary.length;i++){
    const y=listTop+(i+1)*itemH;
    if(y>H-100)break;
    const sel=selectedSongIdx===i;
    const lib=musicLibrary[i];
    ctx.fillStyle=sel?'rgba(0,220,255,0.12)':'rgba(255,255,255,0.03)';
    roundRect(ctx,ox,y,listW,itemH-5,8);ctx.fill();
    ctx.strokeStyle=sel?'#0df':'#333';ctx.lineWidth=sel?2:1;
    roundRect(ctx,ox,y,listW,itemH-5,8);ctx.stroke();
    ctx.textAlign='left';ctx.fillStyle=sel?'#0df':'#ccc';
    ctx.font='bold 16px "Segoe UI",sans-serif';
    ctx.fillText(lib.name,ox+16,y+20);
    ctx.font='12px "Segoe UI",sans-serif';ctx.fillStyle='#888';
    const mins=Math.floor(lib.duration/60),secs=Math.floor(lib.duration%60);
    ctx.fillText(`${mins}:${secs.toString().padStart(2,'0')}  |  ~${lib.bpm} BPM`,ox+16,y+38);
    canvas._songBtns.push({x:ox,y,w:listW,h:itemH-5,idx:i});
  }

  // Play button
  const pbw=200,pbh=50,pbx=W/2-pbw/2,pby=H-80;
  ctx.fillStyle='rgba(0,220,255,0.1)';roundRect(ctx,pbx,pby,pbw,pbh,10);ctx.fill();
  ctx.strokeStyle='#0df';ctx.lineWidth=2;roundRect(ctx,pbx,pby,pbw,pbh,10);ctx.stroke();
  ctx.fillStyle='#0df';ctx.font='bold 20px sans-serif';ctx.textAlign='center';
  ctx.fillText('Play',W/2,pby+pbh/2);
  canvas._playBtn={x:pbx,y:pby,w:pbw,h:pbh};

  ctx.font='12px "Segoe UI",sans-serif';ctx.fillStyle='#445';
  ctx.fillText('Esc: back to menu',W/2,H-20);
}

function drawResults(){
  ctx.textAlign='center';ctx.textBaseline='middle';
  const totalHit=perfects+greats+goods+misses;
  const acc=totalHit>0?((perfects+greats*0.7+goods*0.4)/totalHit*100):100;
  const passed=acc>=50;

  ctx.font='bold 42px "Segoe UI",sans-serif';
  ctx.fillStyle=passed?'#33ffdd':'#ff3355';
  ctx.fillText(passed?'SONG COMPLETE!':'SONG FAILED',W/2,H*0.2);

  // Song name
  if(song&&song.isLoaded&&song.songIdx>=0&&song.songIdx<musicLibrary.length){
    ctx.font='18px "Segoe UI",sans-serif';ctx.fillStyle='#888';
    ctx.fillText(musicLibrary[song.songIdx].name,W/2,H*0.2+40);
  }

  const stats=[
    ['Score',score.toLocaleString(),'#fff'],
    ['Max Combo',maxCombo+'x','#0df'],
    ['Accuracy',acc.toFixed(1)+'%',acc>=90?'#33ffdd':acc>=70?'#ffd700':'#ff3355'],
    ['Perfect',perfects,'#33ffdd'],
    ['Great',greats,'#3355ff'],
    ['Good',goods,'#ffd700'],
    ['Miss',misses,'#ff3355'],
  ];
  const sy=H*0.35;
  for(let i=0;i<stats.length;i++){
    const y=sy+i*36;
    ctx.font='16px "Segoe UI",sans-serif';ctx.textAlign='right';
    ctx.fillStyle='#888';ctx.fillText(stats[i][0],W/2-20,y);
    ctx.font='bold 18px "Segoe UI",sans-serif';ctx.textAlign='left';
    ctx.fillStyle=stats[i][2];ctx.fillText(stats[i][1],W/2+20,y);
  }

  ctx.textAlign='center';ctx.font='16px "Segoe UI",sans-serif';ctx.fillStyle='#556';
  ctx.fillText('Space or click to continue',W/2,H*0.85);
}

// ─── CLICK ───
canvas.addEventListener('click',e=>{
  const mx=e.clientX,my=e.clientY;
  function hit(b){return b&&mx>=b.x&&mx<=b.x+b.w&&my>=b.y&&my<=b.y+b.h;}

  if(state==='menu'){
    if(hit(canvas._menuPlayBtn))state='songSelect';
    if(canvas._diffBtns)for(const b of canvas._diffBtns){if(hit(b))difficulty=b.diff;}
  }else if(state==='songSelect'){
    if(hit(canvas._addSongsBtn))loadSongs();
    if(hit(canvas._proceduralBtn))selectedSongIdx=-1;
    if(canvas._songBtns)for(const b of canvas._songBtns){if(hit(b))selectedSongIdx=b.idx;}
    if(hit(canvas._playBtn)){
      startSong(selectedSongIdx>=0?selectedSongIdx:null);
    }
  }else if(state==='results'){
    state='songSelect';
  }
});

// ─── HELPERS ───
function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
}

function hexToRgb(hex){
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return `${r},${g},${b}`;
}

// ─── LOOP ───
let lastTime=0;
function loop(now){
  const dt=Math.min((now-lastTime)/1000,1/30);
  lastTime=now;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
<!-- Touch Controls: 4 tap lanes -->
<style>
#_tc{position:fixed;bottom:0;left:0;right:0;height:22%;z-index:999;display:none;pointer-events:none}
#_tc.on{display:flex}
._lane{flex:1;border-top:2px solid rgba(255,255,255,0.15);display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.4);font-size:22px;font-weight:700;pointer-events:all;touch-action:none;user-select:none;-webkit-user-select:none;transition:background 0.05s}
._lane:active,._lane.lit{background:rgba(255,255,255,0.18)}
._lane:nth-child(1){background:rgba(100,80,200,0.15)}
._lane:nth-child(2){background:rgba(80,160,100,0.15)}
._lane:nth-child(3){background:rgba(80,160,100,0.15)}
._lane:nth-child(4){background:rgba(100,80,200,0.15)}
</style>
<div id="_tc">
  <div class="_lane" id="_l0">D</div>
  <div class="_lane" id="_l1">F</div>
  <div class="_lane" id="_l2">J</div>
  <div class="_lane" id="_l3">K</div>
</div>
<script>
(function(){
  if(!('ontouchstart' in window))return;
  document.getElementById('_tc').classList.add('on');
  const KEYS=[['d','KeyD'],['f','KeyF'],['j','KeyJ'],['k','KeyK']];
  function sk(k,c,dn){document.dispatchEvent(new KeyboardEvent(dn?'keydown':'keyup',{key:k,code:c,bubbles:true}));}
  KEYS.forEach(([k,c],i)=>{
    const el=document.getElementById('_l'+i);
    el.addEventListener('touchstart',e=>{e.preventDefault();sk(k,c,true);el.classList.add('lit');},{passive:false});
    el.addEventListener('touchend',e=>{e.preventDefault();sk(k,c,false);el.classList.remove('lit');},{passive:false});
    el.addEventListener('touchcancel',()=>{sk(k,c,false);el.classList.remove('lit');});
  });
})();
</script>
</body>
</html>
